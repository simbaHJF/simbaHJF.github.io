---
layout:     post
title:      "Lucene多条件查询文档号合并"
date:       2019-12-13 17:30:00 +0800
author:     "simba"
header-img: "img/post-bg-miui6.jpg"
tags:
    - lucene

---

> 转自:Chris的博客<br>
  https://www.amazingkoala.com.cn/


#	多个MUST的QUERY的文档号合并

##	样例

这种Query组合的文档号合并的代码是在ConjunctionDISI类中实现.本文通过一个例子来介绍文档号合并逻辑.

添加10篇文档到索引中,如下图:

图1:
![Qg6bFK.png](https://s2.ax1x.com/2019/12/13/Qg6bFK.png)

使用WhiteSpaceAnalyzer进行分词.

查询条件如下图,MUST描述了满足查询要求的文档必须包含"a"、"b"、"c"、"e"四个关键字.

图2:
![Qgc0fO.png](https://s2.ax1x.com/2019/12/13/Qgc0fO.png)


##	文档号合并

将包含各个关键字的文档分别放入到各自的数组中,数组元素是文档号.

####	包含"a"的文档号
图3:
![Qgcx9U.png](https://s2.ax1x.com/2019/12/13/Qgcx9U.png)


####	包含"b"的文档号
图4:
![QggMDA.png](https://s2.ax1x.com/2019/12/13/QggMDA.png)


####	包含"c"的文档号
图5:
![Qggc2F.png](https://s2.ax1x.com/2019/12/13/Qggc2F.png)


####	包含"e"的文档号
图6:
![Qg2krj.png](https://s2.ax1x.com/2019/12/13/Qg2krj.png)


`由于满足查询要求的文档中必须都包含"a","b","c","e"四个关键字,所以满足查询要求的文档个数最多是上面几个数组中长度最小的数组的大小.`

所以合并的逻辑即遍历数组大小最小的那个,在上面的例子中,即包含"b"的文档号的数组.每次遍历一个数组元素后,再去其他数组中匹配是否包含这个文档号.遍历其他数组的顺序同样的按照数组元素大小从小到大的顺序,即包含"e"的文档号-->包含"a"的文档号-->包含"c"的文档号.


##	合并过程

从包含"b"的文档号的数组中取出第一个文档号doc1的值1,然后从包含"e"的文档号的数组中取出第一个不小于doc1(1)的文档号doc2的值,也就是5.

比较结果就是doc1(1) != doc2(5),那么没有必要继续跟其他数组作比较了.因为文档号1中不包含关键字"e".

图7:
![Qghj41.png](https://s2.ax1x.com/2019/12/13/Qghj41.png)

接着继续从包含"b"的文档号的数组中取出不小于doc2(5)的值(**<font color="red">这样取是因为,在图7的比较过程中,我们已经确定文档号1~文档号5都不同时包含关键字"b"跟"e",所以下一个比较的文档号并不是直接从包含"b"的文档号的数组中取下一个值,即2,而是根据包含"e"的文档号的数组中的doc2(5)的值,从包含"b"的文档号的数组中取出不小于5的值,即9</font>**),也就是9,doc1更新为9,然后在包含"e"的文档号的数组中取出不小于doc1(9),也就是doc2的值被更新为9:

图8:
![Qg5ZdJ.png](https://s2.ax1x.com/2019/12/13/Qg5ZdJ.png)

比较结果就是doc1(9)=doc2(9),那么我们就需要继续跟剩余的其他数组元素进行比较了,从包含"a"的文档号数组中取出不小于doc1(9)的文档号doc3的值,也就是9:

图9:
![QgIz3q.png](https://s2.ax1x.com/2019/12/13/QgIz3q.png)

这时候由于doc1(9)=doc3(9),所以需要继续跟包含"c"的文档号的数组中的元素进行比较,从包含"c"的文档号的数组中取出不小于doc1(9)的文档号doc4的值,也就是9:

图10:
![Qgomgx.png](https://s2.ax1x.com/2019/12/13/Qgomgx.png)

至此所有的数组都遍历结束,并且文档号9在所有数组中都有出现,即文档号9满足查询要求.

