---
layout:     post
title:      "redis 事件"
date:       2021-03-12 10:00:00 +0800
author:     "simba"
header-img: "img/post-bg-miui6.jpg"
tags:
    - redis

---



## 导航
[一. 前言](#jump1)
<br>
[二. 文件事件](#jump2)
<br>
[三. 时间事件](#jump3)
<br>
[四. 事件的调度与执行](#jump4)
<br>
[五. 小结](#jump5)
<br>








<br><br>
## <span id="jump1">一. 前言</span>

Redis服务器是一个事件驱动程序,服务器需要处理以下两类事件
* 文件事件(file event): Redis服务器通过套接字与客户端(或其他Redis服务器)进行连接,而文件事件就是服务器对套接字操作的抽象.服务器与客户端(或其他服务器)的通信会产生相应的文件事件,而服务器则通过监听并处理这些事件来完成一系列网络通信操作.
* 时间事件(time event): Redis服务器中的一些操作(比如serverCron函数)需要再给定的时间点执行,而时间事件就是服务器对这类定时操作的抽象.



<br><br>
## <span id="jump2">二. 文件事件</span>

Redis基于Reactor模式开发了自己的网络事件处理器:这个处理器被称为文件事件处理器(file event handler)
* 文件事件处理器使用I/O多路复用(multiplexing)程序来同时监听多个套接字,并根据套接字目前执行的任务来为套接字关联不同的事件处理器.
* 当被监听的套接字准备好执行连接应答(accept)、读取(read)、写入(write)、关闭(close)等操作时,与操作相对应的文件事件就会产生,这时文件事件处理器就会掉用那个套接字之前关联好的事件处理器来处理这些事件


<br>
**<font size="4">文件事件处理器的构成</font>** <br>

[![6U3Rjf.png](https://s3.ax1x.com/2021/03/12/6U3Rjf.png)](https://imgtu.com/i/6U3Rjf)

文件事件处理器由四个部分组成,分别是:套接字、I/O多路复用程序、文件事件分配器(dispatcher),以及事件处理器.<br>

文件事件是对套接字操作的抽象,每当一个套接字准备好执行连接应答(accept)、写入、读取、关闭等操作时,就会产生一个文件事件.因为一个服务器通常会连接多个套接字,所以多个文件事件有可能会并发地出现.<br>

I/O多路复用程序负责监听多个套接字,并向文件事件分派器传送那些产生了事件的套接字.<br>

尽管多个文件事件可能会并发地出现,但I/O多路复用程序总能是会将所有产生事件的套接字都放到一个队列里面,然后通过这个队列,以有序(sequentially)、同步(synchronously)、每次一个套接字的方式向文件事件分派器传送套接字.文件事件分派器接收I/O多路复用程序传来的套接字,并根据套接字产生的事件的类型,调用相应的事件处理器.<br>
[![6UJfu6.png](https://s3.ax1x.com/2021/03/12/6UJfu6.png)](https://imgtu.com/i/6UJfu6)


<br>
**<font size="4">I/O多路复用程序的实现</font>** <br>

Redis的I/O多路复用程序的所有功能都是通过包装常见的select、epoll、evport和kqueue这些I/O多路复用函数库来实现的.


<br>
**<font size="4">事件的类型</font>** <br>

* 当套接字变得可读时(客户端对套接字执行write操作,或者执行close操作),或者有新的可应答(acceptable)套接字出现时(客户端对服务器的监听套接字执行connect操作),套接字产生AE_READABLE事件.
* 当套接字变得可写时(客户端对套接字执行read操作),套接字产生AE_WRITABLE事件.

I/O多路复用程序允许服务器同时监听套接字的AE_READABLE事件和AE_WRITABLE事件,如果一个套接字同时产能生了这两种事件,那么文件事件分派器会优先处理AE_READABLE事件,等到AE_READABLE事件处理完成之后,才处理AE_WRITABLE事件.


<br>
**<font size="4">文件事件处理器</font>** <br>

Redis为文件事件编写了多个处理器,这些事件处理器分别用于实现不同的网络通信需求.
* 连接应答处理器 ----- 当Redis服务器进行初始化的时候,程序会将这个连接应答处理器和服务器监听套接字的AE_READABLE事件关联起来,当有客户端连接服务器监听套接字的时候,套接字就会产生AE_READABLE事件,引发连接应答处理器执行,并执行响应的套接字应答操作.
* 命令请求处理器 ----- 负责从套接字中读入客户端发送的命令请求内容,当一个客户端通过连接应答处理器成功连接到服务器之后,服务器会将客户端套接字的AE_READABLE事件和命令请求处理器关联起来,当客户端向服务器发送命令请求的时候,套接字就会产生AE_READABLE事件,引发命令请求处理器执行,并执行相应的套接字读入操作.在客户端连接服务器的整个过程中,服务器都会一直为套接字的AE_READABLE事件关联命令请求处理器
* 命令回复处理器 ----- 负责将服务器执行命令后得到的命令回复通过套接字返回给客户端.当服务器有命令回复需要传送给客户端的时候,服务器会将客户端套接字的AE_WRITABLE事件和命令回复处理器关联起来,当客户端准备好接收服务器传回的命令回复时,就会产生AW_WRITABLE事件,引发命令回复处理器执行,并执行相应的套接字写入操作.
* 复制处理器 ----- 主从服务器进行复制操作时,主从服务器都需要关联特别为复制功能编写的复制处理器


<br>
**<font size="4">一次完整的客户端与服务器连接事件示例</font>** <br>

假设一个Redis服务器正在运作,那么这个服务器的监听套接字的AE_READABLE事件应该正处于监听之下,而该事件所对应的处理器为连接应答处理器.<br>

如果这时有一个Redis客户端你想服务器发起连接,那么减轻套接字将产生AE_READABLE事件,触发连接应答处理器执行.处理器会对客户端的连接请求进行应答,然后创建客户端套接字,以及客户端状态,并将客户端套接字的AE_READABLE事件与命令请求处理器进行关联,使得客户端可以向主服务器发送命令请求.<br>

之后,假设客户端向主服务器发送一个命令请求,那么客户端套接字将产生AE_READABLE事件,引发命令请求处理器执行,处理器读取客户端的命令内容,然后传给相关程序去执行.<br>

执行命令将产生相应的命令回复,为了将这些命令回复传送回客户端,服务器会将客户端套接字的AE_WRITABLE事件与命令回复处理器进行关联.当客户端套接字变为可写时,客户端套接字将产生AE_WRITABLE事件,触发命令回复处理器执行,当命令回复处理器将命令回复全部写入到套接字之后,服务器就会解除客户端套接字的AE_WRITABLE事件与命令回复处理器之间的关联.<br>

返回给用户回复内容前,命令实现函数会将回复先只存放于服务器的客户端输出缓冲区中.至于将结果返回给用户的过程,取决于版本,有不同的操作.<br>

* 在 4.0 以前,每次的回复操作会创建一个写事件,然后放到事件循环中执行(也就是再走一遍:多路复用器 --> 队列 --> 文件事件分派器处理的流程).
* 而 4.0 开始,在每次重新进入一个新的循环之前,Redis 会尝试直接发送给客户端,只有当发送的内容超过一定大小,无法一次发送完成的时候,才会去创建一个可写事件



<br><br>
## <span id="jump3">三. 时间事件</span>

Redis的时间内时间分为以下两类:
* 定时事件: 让一段程序在指定的时间之后执行一次.
* 周期性事件: 让一段程序每隔指定时间就执行一次.

正常模式下的Redis服务器只是用serverCron一个时间事件.<br>


<br>
**<font size="4">时间事件应用实例: serverCron函数</font>** <br>

持续运行的Redis服务器需要定期对自身的资源和状态进行检查和调整,从而确保服务器可以长期、稳定地运行,这些定期操作由serverCron函数负责执行,它的主要工作包括:
* 