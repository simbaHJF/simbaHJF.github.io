---
layout:     post
title:      "redis 复制"
date:       2021-03-13 17:00:00 +0800
author:     "simba"
header-img: "img/post-bg-miui6.jpg"
tags:
    - redis

---



## 导航
[一. 前言](#jump1)
<br>
[二. 旧版复制功能的实现](#jump2)
<br>
[三. 时间事件](#jump3)
<br>
[四. 新版复制功能的实现](#jump4)
<br>
[五. 小结](#jump5)
<br>







<br><br>
## <span id="jump1">一. 前言</span>

在Redis中,可以通过执行SLAVEOF命令或者设置slaveof选型,让一个服务器去复制(replicate)另一个服务器,称被复制的服务器为主服务器(master),对主服务器进行复制的服务器则被称为从服务器(slave).进行复制中的主从服务器双方的数据库将保存相同的数据,称为"数据库状态一致".<br>



<br><br>
## <span id="jump2">二. 旧版复制功能的实现</span>

Redis的复制功能分为同步(sync)和命令传播(command propagate)两个操作:
* 同步操作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态
* 命令传播操作则用于在主服务器的数据库状态被修改,导致主从服务器的数据库状态出现不一致时,让主从服务器的数据库重新回到一直状态


<br>
**<font size="4">同步</font>** <br>

当客户端向从服务器发送SLAVEOF命令,要求从服务器复制主服务器时,从服务器首先需要执行同步操作,也即是,将从服务器的数据库状态更新至主服务器当前所处的数据库状态.<br>

从服务器对主服务器的同步操作需要通过向主服务器发送SYNC命令来完成,以下是SYNC命令的执行步骤:
1. 从服务器向主服务器发送SYNC命令
2. 收到SYNC命令的主服务器执行BGSAVE命令,在后台生成一个RDB文件,并使用一个缓冲区记录从现在开始执行的所有写命令
3. 当主服务器的BGSAVE命令执行完毕时,主服务器会将BGSAVE命令生成的RDB文件发送给从服务器,从服务器接收并载入这个RDB文件,将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态
4. 主服务器将记录在缓冲区里面的所有写命令发送给从服务器,从服务器执行这些写命令,将自己的数据库状态更新至主服务器数据库当前所处的状态

[![6w9j3j.png](https://s3.ax1x.com/2021/03/13/6w9j3j.png)](https://imgtu.com/i/6w9j3j)


<br>
**<font size="4">命令传播</font>** <br>

在同步操作执行完毕之后,主从服务器两者的数据库将达到一致状态,但随着主服务器执行客户端发送的写命令,主服务器的数据库就有可能会被修改,导致主从服务器状态不再一致.为了让主从服务器再次回到一致状态,主服务器需要对从服务器执行命令传播操作:主服务器会将自己执行的写命令,发送给从服务器执行,当从服务器执行了相同的写命令之后,主从服务器将再次回到一致状态<br>



<br><br>
## <span id="jump3">三. 旧版复制功能的缺陷</span>

Redis中,从服务器对主服务器的复制可以分为以下两种情况:
* 初次复制: 从服务器以前没有复制过任何主服务器,或者从服务器当前要复制的主服务器和上次复制的主服务器不同
* 断线后重复制: 处于命令传播阶段的的主从服务器因为网络原因而中断了复制,但从服务器通过自动重连接重新连上了主服务器,并继续复制主服务器.

对于初次复制来说,旧版复制功能可以很好地完成任务,但对于断线后重复制来说,旧版复制功能就十分低效.SYNC是一个十分重的操作命令.



<br><br>
## <span id="jump4">四. 新版复制功能的实现</span>

为解决旧版复制功能在处理断线重复制情况时的低效问题,Redis从2.8版本开始,使用PSYNC命令代替SYNC命令来执行复制时的同步操作.PSYNC具有完整重同步和部分重同步两种模式:
* 完整重同步用于处理初次复制情况,其执行步骤和SYNC命令的执行步骤基本一样,都是通过让主服务器创建并发送RDB文件,以及向从服务器发送保存在缓冲区里面的写命令来进行同步.
* 部分重同步则用于处理断线后重复制情况:当从服务器在断线后重新连接主服务器时,如果条件允许,主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器,从服务器只要接收并执行这些写命令,就可以将数据库更新至主服务器当前所处的状态.